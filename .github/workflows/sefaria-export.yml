name: Python 3.9 + MongoDB + Sefaria Export to Otzaria (consolidated inline)

on:
  workflow_dispatch:
    inputs:
      timezone:
        description: "Timezone for timestamp/tag (IANA name)"
        required: false
        default: "Asia/Jerusalem"

permissions:
  contents: write

env:
  TZ_NAME: ${{ inputs.timezone || 'Asia/Jerusalem' }}
  DJANGO_SETTINGS_MODULE: sefaria.settings
  MONGO_HOST: 127.0.0.1
  MONGO_PORT: 27017
  MONGO_DB_NAME: sefaria
  SEFARIA_TO_OTZARIA_PATH: ${{ github.workspace }}/sefariaToOtzaria

jobs:
  export_release:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ github.workspace }}

    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd="mongosh --eval 'db.runCommand({ ping: 1 })'"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=20

    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          clean: true

      - name: Debug workspace
        run: |
          echo "GITHUB_WORKSPACE=${GITHUB_WORKSPACE}"
          echo "PWD=$(pwd)"
          echo "Listing top-level files:" && ls -la
          echo "Current directory structure:"
          ls -la ./

      # 01_compute_timestamp.sh
      - name: Compute release timestamp
        id: ts
        run: |
          set -euo pipefail
          # Compute release timestamp and expose it via GITHUB_OUTPUT
          TZ="${TZ_NAME:-Asia/Jerusalem}" date '+%Y-%m-%d_%H-%M' > ts.txt
          echo "stamp=$(cat ts.txt)" >> "${GITHUB_OUTPUT}"

      # 02_install_base_tools.sh
      - name: Install base tools
        run: |
          set -euo pipefail
          if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y aria2 ca-certificates tar zstd wget netcat-openbsd
          fi
          python3 -V || true

      - name: Set up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      # 03_install_mongo_tools.sh
      - name: Install MongoDB Database Tools (mongorestore)
        run: |
          set -euo pipefail
          TOOLS_VER="100.9.4"
          if ! command -v mongorestore >/dev/null 2>&1; then
            wget -q "https://fastdl.mongodb.org/tools/db/mongodb-database-tools-ubuntu2204-x86_64-${TOOLS_VER}.tgz"
            tar -xzf "mongodb-database-tools-ubuntu2204-x86_64-${TOOLS_VER}.tgz"
            sudo mv "mongodb-database-tools-ubuntu2204-x86_64-${TOOLS_VER}/bin"/* /usr/local/bin/
          fi
          mongorestore --version

      # 04_download_small_dump.sh
      - name: Download small Mongo dump
        run: |
          set -euo pipefail
          mkdir -p mongo_dump
          aria2c -x 16 -s 16 -k 1M -o dump_small.tar.gz "https://storage.googleapis.com/sefaria-mongo-backup/dump_small.tar.gz"
          tar -xzf dump_small.tar.gz -C mongo_dump
          rm dump_small.tar.gz
          mkdir -p mongo_dump_pkg
          if [ -d mongo_dump/dump/sefaria ]; then
            cp -a mongo_dump/dump/sefaria mongo_dump_pkg/
          elif [ -d mongo_dump/sefaria ]; then
            cp -a mongo_dump/sefaria mongo_dump_pkg/
          else
            echo "‚ùå 'sefaria' folder not found in dump"; exit 1
          fi
          rm -rf mongo_dump
          find mongo_dump_pkg -maxdepth 2 -type d -print

      # 05_clone_sefaria_project.sh
      - name: Clone Sefaria-Project
        run: |
          set -euo pipefail
          git clone --depth 1 --single-branch --no-tags https://github.com/Sefaria/Sefaria-Project.git
          cd Sefaria-Project
          rm -rf .git
          ls -la | head -n 50

      # 06_install_build_deps.sh
      - name: Install build deps (google-re2)
        run: |
          set -euo pipefail
          if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y libre2-dev pybind11-dev build-essential cmake ninja-build
          fi

      # 07_pip_install_requirements.sh
      - name: Pin google-re2 and install requirements
        id: pip_install
        continue-on-error: true
        run: |
          set -euo pipefail
          cd Sefaria-Project
          echo "google-re2==1.0" > constraints-ci.txt
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt -c constraints-ci.txt

      # 08_fallback_built_google_re2.sh
      - name: Fallback built-google-re2
        if: ${{ steps.pip_install.outcome == 'failure' }}
        run: |
          set -euo pipefail
          cd Sefaria-Project
          echo "Primary install failed ‚Äî trying built-google-re2 fallback..."
          grep -viE '^\s*google-re2' requirements.txt > req-no-re2.txt || true
          pip install -r req-no-re2.txt
          pip install built-google-re2

      # 09_create_exports_dir.sh
      - name: Create exports directory
        run: |
          set -euo pipefail
          EXPORTS_DIR="${SEFARIA_TO_OTZARIA_PATH}/new_export"
          mkdir -p "${EXPORTS_DIR}"
          echo "SEFARIA_EXPORT_BASE=${EXPORTS_DIR}" >> "${GITHUB_ENV}"

      # 10_create_local_settings.sh
      - name: Create local_settings.py (SEFARIA_DB, export path)
        run: |
          set -euo pipefail
          cd Sefaria-Project/sefaria
          cp local_settings_example.py local_settings.py
          python ../../configure_local_settings.py
          
          echo ""
          echo "üìÑ Checking local_settings.py content:"
          grep -E "(SEFARIA_EXPORT_PATH|MONGO_HOST|MONGO_PORT|SEFARIA_DB)" local_settings.py || true

      # 11_wait_for_mongodb.sh
      - name: Wait for MongoDB TCP
        run: |
          set -euo pipefail
          for i in {1..60}; do
            if nc -z 127.0.0.1 27017; then
              echo "‚úÖ MongoDB reachable"; exit 0
            fi
            echo "‚è≥ Waiting for MongoDB..."; sleep 2
          done
          echo "‚ùå MongoDB not reachable in time" >&2
          exit 1

      # 12_restore_db_from_dump.sh
      - name: Restore database from dump
        run: |
          set -euo pipefail
          
          # Configurable via env, with sensible defaults
          MONGO_HOST=${MONGO_HOST:-127.0.0.1}
          MONGO_PORT=${MONGO_PORT:-27017}
          MONGO_DB_NAME=${MONGO_DB_NAME:-sefaria}
          
          # How to handle index restoration:
          #   all        -> restore all indexes via metadata-only pass
          #   skip_links -> restore all indexes EXCEPT for the heavy sefaria.links indexes (default)
          #   none       -> do not restore any indexes (data only)
          RESTORE_INDEXES_MODE=${RESTORE_INDEXES_MODE:-skip_links}
          
          echo "üì¶ Preparing to restore MongoDB dump"
          echo "   Host: ${MONGO_HOST}:${MONGO_PORT}"
          echo "   DB  : ${MONGO_DB_NAME}"
          echo "   Index mode: ${RESTORE_INDEXES_MODE} (override with RESTORE_INDEXES_MODE=all|skip_links|none)"
          
          if [ ! -d mongo_dump_pkg/sefaria ]; then
            echo "‚ùå mongo_dump_pkg/sefaria not found"; exit 1
          fi
          
          # Phase 1: Restore DATA ONLY (no indexes) to avoid long-running index builds during import
          echo "‚ñ∂Ô∏è  Restoring data (no indexes)..."
          mongorestore \
            --host "${MONGO_HOST}" \
            --port "${MONGO_PORT}" \
            --drop \
            --db "${MONGO_DB_NAME}" \
            --noIndexRestore \
            "mongo_dump_pkg/sefaria"
          
          echo "‚úÖ Data restore completed."
          
          echo ""
          echo "üîé Checking mongorestore capabilities..."
          MONGORESTORE_HELP=$(mongorestore --help 2>&1 || true)
          if echo "$MONGORESTORE_HELP" | grep -q -- "--metadataOnly"; then
            HAS_METADATA_ONLY=1
            echo "‚úÖ mongorestore supports --metadataOnly"
          else
            HAS_METADATA_ONLY=0
            echo "‚ö†Ô∏è  mongorestore does NOT support --metadataOnly on this machine."
          fi
          
          # Phase 2: Optionally restore metadata (indexes) with exclusions to avoid timeouts on heavy collections
          case "${RESTORE_INDEXES_MODE}" in
            all)
              if [ "$HAS_METADATA_ONLY" -eq 1 ]; then
                echo "‚ñ∂Ô∏è  Restoring metadata (indexes) for all collections..."
                mongorestore \
                  --host "${MONGO_HOST}" \
                  --port "${MONGO_PORT}" \
                  --db "${MONGO_DB_NAME}" \
                  --metadataOnly \
                  "mongo_dump_pkg/sefaria"
                echo "‚úÖ Index metadata restored for all collections."
              else
                echo "‚ÑπÔ∏è  Falling back: skipping metadata restore because --metadataOnly is unavailable."
                echo "    To attempt index creation from dump metadata.json, set ENABLE_INDEXES_FROM_METADATA=true"
              fi
              ;;
            skip_links)
              if [ "$HAS_METADATA_ONLY" -eq 1 ]; then
                echo "‚ñ∂Ô∏è  Restoring metadata (indexes) for all collections EXCEPT '${MONGO_DB_NAME}.links'..."
                mongorestore \
                  --host "${MONGO_HOST}" \
                  --port "${MONGO_PORT}" \
                  --db "${MONGO_DB_NAME}" \
                  --metadataOnly \
                  --nsExclude "${MONGO_DB_NAME}.links" \
                  "mongo_dump_pkg/sefaria"
                echo "‚úÖ Index metadata restored (links collection skipped)."
              else
                echo "‚ÑπÔ∏è  Falling back: skipping metadata restore because --metadataOnly is unavailable."
                echo "    To attempt index creation from dump metadata.json (excluding links), set ENABLE_INDEXES_FROM_METADATA=true"
              fi
              ;;
            none)
              echo "‚è≠Ô∏è  Skipping index restoration as requested (RESTORE_INDEXES_MODE=none)."
              ;;
            *)
              echo "‚ö†Ô∏è  Unknown RESTORE_INDEXES_MODE='${RESTORE_INDEXES_MODE}'. Use one of: all | skip_links | none" >&2
              exit 2
              ;;
          esac
          
          # Optional fallback: create indexes by reading metadata.json files when --metadataOnly is unavailable
          if [ "${ENABLE_INDEXES_FROM_METADATA:-false}" = "true" ] && [ "$HAS_METADATA_ONLY" -eq 0 ] && [ "${RESTORE_INDEXES_MODE}" != "none" ]; then
            echo "üß© ENABLE_INDEXES_FROM_METADATA=true ‚Äî attempting to apply indexes from dump metadata.json"
            python ./apply_indexes_from_dump.py || echo "‚ö†Ô∏è  apply_indexes_from_dump.py encountered errors; continuing without blocking the pipeline."
          fi
          
          # Ensure 'history' collection exists (some exports expect it)
          python ./ensure_history_collection.py
          
          # Clean up dump files to free space
          rm -rf mongo_dump_pkg
          
          echo "‚úÖ Mongo restore complete."

      # 13_check_export_module.sh
      - name: Check export module available
        run: |
          set -euo pipefail
          export PYTHONPATH="${GITHUB_WORKSPACE:-$PWD}/Sefaria-Project"
          if ! python ./check_export_module.py; then
            echo "‚ùå Failed to load export module"
          fi

      # 14_run_exports.sh
      - name: Run export functions
        run: |
          set -euo pipefail
          export PYTHONPATH="${GITHUB_WORKSPACE:-$PWD}/Sefaria-Project"
          python sefariaToOtzaria/◊°◊ß◊®◊ô◊§◊ò◊ô◊ù/from_export/run_exports.py

      # 15_verify_exports.sh
      - name: Detailed export verification
        run: |
          set -euo pipefail
          EXPORTS_DIR="${SEFARIA_TO_OTZARIA_PATH}/new_export"
          echo "üìÅ Full tree of exports directory:"
          if command -v tree >/dev/null 2>&1; then
            tree -L 3 "${EXPORTS_DIR}" || true
          else
            # Avoid SIGPIPE with head under pipefail by using awk to limit lines
            find "${EXPORTS_DIR}" -type d | awk 'NR<=30'
          fi
          
          echo ""
          echo "üìä Export directory size:"
          du -sh "${EXPORTS_DIR}"
          du -sh "${EXPORTS_DIR}"/* 2>/dev/null || echo "No subdirectories"
          
          echo ""
          echo "üìÑ File count:"
          find "${EXPORTS_DIR}" -type f | wc -l
          
          echo ""
          echo "üìù First 20 files:"
          ## Use awk to avoid Broken pipe errors with set -o pipefail
          find "${EXPORTS_DIR}" -type f | awk 'NR<=20'

      # 16_drop_db.sh
      - name: Drop DB (free space)
        run: |
          set -euo pipefail
          mongosh --quiet --eval 'db.getSiblingDB("sefaria").dropDatabase(); print("‚úÖ DB dropped.")' || true
          df -h
      - name: delate un-nesserry-files
        run: |
          rm -rf "${SEFARIA_TO_OTZARIA_PATH}/new_export/cltk-flat"
          rm -rf "${SEFARIA_TO_OTZARIA_PATH}/new_export/cltk-full"
          rm -rf "${SEFARIA_TO_OTZARIA_PATH}/new_export/txt"
          rm -rf "${GITHUB_WORKSPACE:-$PWD}/Sefaria-Project"


      # Run sefariaToOtzaria conversion scripts with Python 3.12
      - name: Set up Python 3.12 for conversion scripts
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          
      - name: Run Sefaria to Otzaria conversion scripts
        working-directory: "sefariaToOtzaria/◊°◊ß◊®◊ô◊§◊ò◊ô◊ù/from_export"
        run: |
          pip install -r requirements.txt
          python export.py
          rm -rf "${SEFARIA_TO_OTZARIA_PATH}/new_export/json"
          rm -rf "${SEFARIA_TO_OTZARIA_PATH}/new_export/schemas"
          python links.py
          python folder_metadata.py

      # Move converted files to sefaria_export
      - name: Move converted files to sefaria_export
        run: |
          set -euo pipefail
          
          echo "üì¶ Moving converted files to sefaria_export..."
          
          # Remove existing target directories
          echo "üóëÔ∏è  Removing existing directories..."
          rm -rf "${SEFARIA_TO_OTZARIA_PATH}/sefaria_export/◊°◊§◊®◊ô◊ù/◊ê◊ï◊¶◊®◊ô◊ê"
          rm -rf "${SEFARIA_TO_OTZARIA_PATH}/sefaria_export/links"
          echo "‚úÖ Existing directories removed."
          
          # Create target directories
          mkdir -p "${SEFARIA_TO_OTZARIA_PATH}/sefaria_export/◊°◊§◊®◊ô◊ù/◊ê◊ï◊¶◊®◊ô◊ê"
          mkdir -p "${SEFARIA_TO_OTZARIA_PATH}/sefaria_export/links"
          
          # Move books from new_books/◊ê◊ï◊¶◊®◊ô◊ê to sefaria_export/◊°◊§◊®◊ô◊ù/◊ê◊ï◊¶◊®◊ô◊ê
          if [ -d "${SEFARIA_TO_OTZARIA_PATH}/new_books/◊ê◊ï◊¶◊®◊ô◊ê" ]; then
            echo "üìö Moving books from new_books/◊ê◊ï◊¶◊®◊ô◊ê..."
            mv "${SEFARIA_TO_OTZARIA_PATH}/new_books/◊ê◊ï◊¶◊®◊ô◊ê"/* \
               "${SEFARIA_TO_OTZARIA_PATH}/sefaria_export/◊°◊§◊®◊ô◊ù/◊ê◊ï◊¶◊®◊ô◊ê/" 2>/dev/null || true
            echo "‚úÖ Books moved."
          else
            echo "‚ö†Ô∏è  No books directory found at new_books/◊ê◊ï◊¶◊®◊ô◊ê"
          fi

          # Move links from new_books/links to sefaria_export/links
          if [ -d "${SEFARIA_TO_OTZARIA_PATH}/new_books/links" ]; then
            echo "üîó Moving links..."
            mv "${SEFARIA_TO_OTZARIA_PATH}/new_books/links"/* \
               "${SEFARIA_TO_OTZARIA_PATH}/sefaria_export/links/" 2>/dev/null || true
            echo "‚úÖ Links moved."
          else
            echo "‚ö†Ô∏è  No links directory found"
          fi
          
          echo "‚úÖ All files moved to sefaria_export."

      # Cleanup temporary directories
      - name: Cleanup temporary directories
        run: |
          set -euo pipefail
          
          echo "üßπ Cleaning up temporary directories..."
          
          # Remove new_export directory
          if [ -d "${SEFARIA_TO_OTZARIA_PATH}/new_export" ]; then
            rm -rf "${SEFARIA_TO_OTZARIA_PATH}/new_export"
            echo "‚úÖ Removed new_export directory"
          fi
          
          # Remove new_books directory
          if [ -d "${SEFARIA_TO_OTZARIA_PATH}/new_books" ]; then
            rm -rf "${SEFARIA_TO_OTZARIA_PATH}/new_books"
            echo "‚úÖ Removed new_books directory"
          fi
          
          echo "‚úÖ Cleanup completed."

      # Commit and push changes
      - name: Commit and push changes to repository
        run: |
          set -euo pipefail
          
          cd "${GITHUB_WORKSPACE}"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add all changes in sefariaToOtzaria directory
          git add sefariaToOtzaria/
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è  No changes to commit"
          else
            echo "üìù Committing changes..."
            git commit -m "Update Sefaria export to Otzaria format - $(date '+%Y-%m-%d %H:%M')"
            
            echo "‚¨ÜÔ∏è  Pushing changes to repository..."
            git push
            
            echo "‚úÖ Changes pushed successfully"
          fi